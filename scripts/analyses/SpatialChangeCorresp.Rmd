---
title: "Untitled"
author: "Adam"
date: "10/16/2020"
output: html_document
---

```{r}
library(ggplot2)
library(ggpointdensity)
library(ggridges)
library(reshape2)
library(ggExtra)
library(hexbin)

L=read.csv('/cbica/projects/pinesParcels/results/aggregated_data/vertexWiseChange_LH.csv')
R=read.csv('/cbica/projects/pinesParcels/results/aggregated_data/vertexWiseChange_RH.csv')

LMAD=read.csv('/cbica/projects/pinesParcels/results/aggregated_data/vertexWiseMAD_LH.csv')
RMAD=read.csv('/cbica/projects/pinesParcels/results/aggregated_data/vertexWiseMAD_RH.csv')

LPG=read.csv('/cbica/projects/pinesParcels/results/aggregated_data/vertexWisePG_LH.csv')
RPG=read.csv('/cbica/projects/pinesParcels/results/aggregated_data/vertexWisePG_RH.csv')

L10=read.csv('/cbica/projects/pinesParcels/results/aggregated_data/vertexWise_10_LH.csv')
R10=read.csv('/cbica/projects/pinesParcels/results/aggregated_data/vertexWise_10_RH.csv')
L21=read.csv('/cbica/projects/pinesParcels/results/aggregated_data/vertexWise_21_LH.csv')
R21=read.csv('/cbica/projects/pinesParcels/results/aggregated_data/vertexWise_21_RH.csv')

# part that is not over scales
DF_10=data.frame(c(L10[,1],R10[,1]),unlist(c(LPG[1,],RPG[1,])))
DF_21=data.frame(c(L21[,1],R21[,1]),unlist(c(LPG[1,],RPG[1,])))

colnames(DF_10)<-c('Bw10','PG')
colnames(DF_21)<-c('Bw21','PG')

hexinfo <- hexbin(DF_10$Bw10, DF_10$PG, xbins = 40)
data_hex <- data.frame(hcell2xy(hexinfo), count = hexinfo@count)
colnames(data_hex)<-c('Bw10','PG','count')

ggMarginal(ggplot(DF_10,aes(x=Bw10,y=PG)) + geom_hex(bins=40) + scale_color_viridis_c(option='inferno')+geom_point(alpha=0)+geom_smooth(method='lm',color='gray')+theme_classic()+theme(legend.position = "bottom")+ylim(c(-6.6,7))+xlim(c(-.047,0.027))+ggtitle('Bw@10'))

hexinfo <- hexbin(DF_21$Bw21, DF_21$PG, xbins = 40)
data_hex <- data.frame(hcell2xy(hexinfo), count = hexinfo@count)
colnames(data_hex)<-c('Bw21','PG','count')

ggMarginal(ggplot(DF_21,aes(x=Bw21,y=PG)) + geom_hex(bins=40) + scale_color_viridis_c(option='inferno')+geom_point(alpha=0)+geom_smooth(method='lm',color='gray')+theme_classic()+theme(legend.position = "bottom")+ylim(c(-6.6,7))+xlim(c(-.047,0.027))+ggtitle('Bw@21'))



# initialize vectors
spatCorvec_L<-rep(0,30)
spatCorvec_R<-rep(0,30)
spatCorvec<-rep(0,30)

for (K in 2:30){
  x=data.frame(scale(c(L[,K],R[,K])),scale(c(L[,1],R[,1])))
  MADx=data.frame(scale(c(LMAD[,K],RMAD[,K])),scale(c(L[,K],R[,K])))
  colnames(x)<-c('LoadingChange','GradChange')
  colnames(MADx)<-c('MAD','LoadingChange')
  hexinfo <- hexbin(MADx$LoadingChange, MADx$MAD, xbins = 40)
  data_hex <- data.frame(hcell2xy(hexinfo), count = hexinfo@count)
  colnames(data_hex)<-c('LoadingChange','MAD','count')
  print(ggMarginal(ggplot(MADx,aes(x=LoadingChange,y=MAD)) + geom_hex(bins=30) + scale_color_viridis_c(option='inferno')+ggtitle(paste(K))+geom_point(alpha=0)+geom_smooth(method='lm',color='gray')+theme_classic()+theme(legend.position = "bottom")),type="density")
  #print(ggMarginal(ggplot(MADx,aes(x=LoadingChange,y=MAD)) + geom_pointdensity(adjust=1) + scale_color_viridis_c(option='inferno')+ggtitle(paste(K))+geom_smooth(method='lm',color='gray')+theme_classic()+theme(legend.position = "bottom")),type="density")
  # definitely not normally distr.
  spatCorvec_R[K]<-cor.test(R[,K],R[,1],method='spearman')$estimate
  spatCorvec_L[K]<-cor.test(L[,K],L[,1],method='spearman')$estimate
  spatCorvec[K]<-cor.test(MADx$LoadingChange,MADx$MAD,method='spearman')$estimate
  # PG and loading change
  #spatCorvec[K]<-cor.test(x$LoadingChange,x$GradChange,method='spearman')$estimate
}
#for (K in 2:30){
#  x=data.frame(L[,K],L[,1])
#  colnames(x)<-c('LoadingChange','GradChange')
#  print(ggplot(x,aes(x=LoadingChange,y=GradChange)) + geom_pointdensity(adjust=.001) + scale_color_viridis_c())
#  plot(L[,K],L[,1],ylim=c(0,4))
  # definitely not normally distr.
#  spatCorvec_L[K-1]<-cor.test(L[,K],L[,1],method='spearman')$estimate
#}

# get z-scores of grad change
zscoredGradChange<-scale(c(L[,1],R[,1]))

# save the z-scored dif
for (K in 2:30){
  # get z-score of community change at this scale
  zcoredCommChange<-scale(c(L[,K],R[,K]))
  zScoredDif<-zscoredGradChange-zcoredCommChange
  spatChangL<-zScoredDif[1:(dim(L)[1])]
  spatChangR<-zScoredDif[((dim(L)[1])+1):((dim(L)[1])+dim(R)[1])]
  fn<-paste('/cbica/projects/pinesParcels/results/aggregated_data/spatChangeZDif_K_',K,'.csv',sep='')
  write.table(c(spatChangL,spatChangR),fn,sep=',', col.names = F,quote = F,row.names=F)
}

plot(spatCorvec)
```

```{r}
# color vector for highlighting 4 different scales
grayHexa<-'#a19f9f'
fourscalescheme<-rep(grayHexa,29)
# scale 4 - purple
fourscalescheme[3]<-'#490091'
# scale 7 - yellow
#fourscalescheme[6]<- '#FFCC00'
# scale 13 - black
fourscalescheme[12]<- '#cca300' 
# scale 20 - red
fourscalescheme[19]<- '#a30000'
  
# load in spin test distributions
spinDistr<-read.csv('/cbica/projects/pinesParcels/results/aggregated_data/SpinTestDistrs.csv')

# melt this into 1001*29 columns 
m_spinDistr<-melt(spinDistr)

# add a "scale" column
m_spinDistr$Scale<-rep(2:30,each=1001)
# add a "realCor" boolean column
repeatVector<-array(0,dim=c(1001,1))
repeatVector[1]<-1
m_spinDistr$RealCor<-rep(rep(c(1,0),c(1,1000)),times=29)
m_spinDistr$Scale<-as.factor(m_spinDistr$Scale)

ggplot(m_spinDistr[m_spinDistr$RealCor==0,], aes(x = value, y = Scale, group = Scale))+xlab(expression(rho)) + geom_jitter(size = 0.75,alpha=.25) +geom_point(data=m_spinDistr[m_spinDistr$RealCor==1,],aes(x=value,y=Scale),size=3)+scale_fill_manual(values=fourscalescheme)+theme_minimal(base_size = 17)+coord_flip()+theme(legend.position = "none")+xlim(c(-.285,.85))+ylab('# of Communities') +ggtitle('Func Transitions: Group atlas at K correlations with PG1')

# load in spin test distributions
spinDistr_MAD<-read.csv('/cbica/projects/pinesParcels/results/aggregated_data/SpinTestDistrs_MAD.csv')

# melt this into 1001*29 columns 
m_spinDistr<-melt(spinDistr_MAD)
# add a "scale" column
m_spinDistr$Scale<-rep(2:30,each=1001)
# add a "realCor" boolean column
repeatVector<-array(0,dim=c(1001,1))
repeatVector[1]<-1
m_spinDistr$RealCor<-rep(rep(c(1,0),c(1,1000)),times=29)
m_spinDistr$Scale<-as.factor(m_spinDistr$Scale)
for(K in c(4,7,13,20)){
  m_spinDistr_Scale<-subset(m_spinDistr,Scale==K)
  RealCorrelation<-m_spinDistr_Scale$value[1]
  # starting at 2 because 1 is real
  P_Value = length(which(m_spinDistr_Scale$value[2:1001] >= RealCorrelation)) / 1000;
  ggplot(subset(m_spinDistr_Scale, RealCor==0),aes(x=value))+geom_density()+geom_vline(xintercept = RealCorrelation,linetype="dashed")+theme_classic(base_size=40)+ylab('')+xlab(expression(rho))+guides(y="none")
  ggplot(subset(m_spinDistr_Scale, RealCor==0),aes(x=value))+geom_density(linetype='dashed',size=1.5)+geom_vline(xintercept =  RealCorrelation,size=2,color='#BC3754')+theme_classic(base_size=40)+ylab('')+xlab(expression(rho))+guides(y="none")
}

#ggplot(m_spinDistr[m_spinDistr$RealCor==0,], aes(x = value, y = Scale, group = Scale))+xlab(expression(rho)) + geom_jitter(size = 0.75,alpha=.25) +geom_point(data=m_spinDistr[m_spinDistr$RealCor==1,],aes(x=value,y=Scale),size=3)+scale_fill_manual(values=fourscalescheme)+theme_minimal(base_size = 17)+coord_flip()+theme(legend.position = "none")+xlim(c(-.35,.85))+ylab('# of Communities')+ggtitle('Func Transitions: Group atlas at K correlations with MAD at K')

# load in spin test distributions for MAD and PG
spinDistr_PG_MAD<-read.csv('/cbica/projects/pinesParcels/results/aggregated_data/SpinTestDistrs_MAD_PG1.csv')

# melt this into 1001*29 columns 
m_spinDistr<-melt(spinDistr_PG_MAD)

# add a "scale" column
m_spinDistr$Scale<-rep(2:30,each=1001)
# add a "realCor" boolean column
repeatVector<-array(0,dim=c(1001,1))
repeatVector[1]<-1
m_spinDistr$RealCor<-rep(rep(c(1,0),c(1,1000)),times=29)
m_spinDistr$Scale<-as.factor(m_spinDistr$Scale)
for(K in c(4,7,13,20)){
  m_spinDistr_Scale<-subset(m_spinDistr,Scale==K)
  RealCorrelation<-m_spinDistr_Scale$value[1]
  P_Value = length(which(m_spinDistr_Scale$value[2:1001] >= RealCorrelation)) / 1000;
  ggplot(subset(m_spinDistr_Scale, RealCor==0),aes(x=value))+geom_density()+geom_point(data = m_spinDistr_Scale[1,],aes(y=0),size=7,color='#BC3754')+theme_classic(base_size=40)+ylab('')+xlab(expression(rho))+guides(y="none")
  ggplot(subset(m_spinDistr_Scale, RealCor==0),aes(x=value))+geom_density(linetype='dashed',size=1.5)+geom_vline(xintercept =  RealCorrelation,size=2,color='#BC3754')+theme_classic(base_size=40)+ylab('')+xlab(expression(rho))+guides(y="none")
}

#ggplot(m_spinDistr[m_spinDistr$RealCor==0,], aes(x = value, y = Scale, group = Scale))+xlab(expression(rho)) + geom_jitter(size = 0.75,alpha=.25) +geom_point(data=m_spinDistr[m_spinDistr$RealCor==1,],aes(x=value,y=Scale),size=3)+scale_fill_manual(values=fourscalescheme)+theme_minimal(base_size = 17)+coord_flip()+theme(legend.position = "none")+xlim(c(-.35,.85))+ylab('# of Communities')+ggtitle('Func Transitions: PG1 correlations with MAD at K')
```